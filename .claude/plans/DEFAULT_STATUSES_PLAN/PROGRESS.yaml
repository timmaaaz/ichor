# Default Status Management - Progress Tracking
# This file tracks the implementation progress of default status management

project:
  name: "Default Status Management"
  description: "Implement default status management using form configuration + workflow engine"
  started: "2025-12-29"
  status: "planning"  # planning | in_progress | completed | blocked
  current_phase: 1

  summary:
    phases_total: 3
    phases_completed: 0
    phases_in_progress: 0
    phases_pending: 3
    files_created: 1
    files_modified: 0

planning_status:
  phase_1_doc_created: true
  phase_2_doc_created: false
  phase_3_doc_created: false
  next_phase_to_document: 2

phases:
  - phase: 1
    name: "Form Configuration FK Default Resolution"
    description: "Enable form fields to specify default values by name for FK fields, resolved to UUIDs during form processing"
    status: "pending"  # pending | in_progress | completed | blocked
    category: "backend"  # backend | frontend | database | fullstack | testing | documentation
    last_review: "2025-12-29"
    review_status: "approved"

    tasks:
      - task: "1. Add Logger to formdataapp"
        status: "pending"
        notes:
          - "Logger required for FK resolution warnings"
          - "Add as FIRST field/parameter per Ardan Labs convention"
        files:
          - path: "app/domain/formdata/formdataapp/formdataapp.go"
            status: "pending"

      - task: "2. Add resolveFKByName Method"
        status: "pending"
        notes:
          - "Registry whitelist validation for security"
          - "UUID pass-through for fast path"
          - "Parameterized queries for user values"
        files:
          - path: "app/domain/formdata/formdataapp/formdataapp.go"
            status: "pending"

      - task: "3. Update mergeFieldDefaults for FK Resolution"
        status: "pending"
        notes:
          - "Add ctx context.Context as first parameter"
          - "Call resolveFKByName for fields with entity config"
        files:
          - path: "app/domain/formdata/formdataapp/formdataapp.go"
            status: "pending"

      - task: "4. Update mergeLineItemFieldDefaults"
        status: "pending"
        notes:
          - "Add ctx parameter and FK resolution"
          - "Use DropdownConfig.Entity for FK lookup"
        files:
          - path: "app/domain/formdata/formdataapp/formdataapp.go"
            status: "pending"

      - task: "5. Update all.go Call Site"
        status: "pending"
        notes:
          - "Pass cfg.Log as first argument to NewApp"
        files:
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "pending"

      - task: "6. Add Max Array Size Validation"
        status: "pending"
        notes:
          - "Prevent DoS via unbounded array submissions"
          - "maxArrayItems = 1000"
        files:
          - path: "app/domain/formdata/formdataapp/formdataapp.go"
            status: "pending"

      - task: "7. Update Form Seed Data"
        status: "pending"
        notes:
          - "Add default_value_create: 'Pending' to status FK fields"
          - "Orders and line items get default status"
        files:
          - path: "business/sdk/dbtest/seedmodels/forms.go"
            status: "pending"
          - path: "business/sdk/dbtest/seedmodels/tableforms.go"
            status: "pending"

      - task: "8. Add Unit Tests"
        status: "pending"
        notes:
          - "Test resolveFKByName with valid name"
          - "Test UUID pass-through"
          - "Test unknown entity rejection"
          - "Test value not found"
        files:
          - path: "app/domain/formdata/formdataapp/fkresolution_test.go"
            status: "pending"

      - task: "9. Add Integration Tests"
        status: "pending"
        notes:
          - "Order without status gets Pending"
          - "Explicit status preserved"
          - "Line items get default status"
        files:
          - path: "api/cmd/services/ichor/tests/formdata/formdataapi/upsert_test.go"
            status: "pending"
          - path: "api/cmd/services/ichor/tests/formdata/formdataapi/seed_test.go"
            status: "pending"

    validation:
      - check: "Go compilation passes"
        status: "pending"
      - check: "make test passes"
        status: "pending"
      - check: "Orders without status get Pending UUID"
        status: "pending"
      - check: "Line items without status get Pending UUID"
        status: "pending"
      - check: "Invalid names log warning but don't fail request"
        status: "pending"
      - check: "User-provided values preserved (not overwritten)"
        status: "pending"
      - check: "UUID values pass through without database lookup"
        status: "pending"
      - check: "Unregistered entities rejected before query"
        status: "pending"
      - check: "Array size limited to maxArrayItems (1000)"
        status: "pending"

    deliverables:
      - "formdataapp.App.log field added"
      - "formdataapp.resolveFKByName method"
      - "Updated mergeFieldDefaults with ctx and FK resolution"
      - "Updated mergeLineItemFieldDefaults with ctx and FK resolution"
      - "Updated all.go call site"
      - "maxArrayItems constant and validation"
      - "Form seed data with default_value_create: Pending"
      - "Unit tests for FK resolution"
      - "Integration tests for default status injection"

    blockers: []

  - phase: 2
    name: "Workflow Integration for Status Transitions"
    description: "Wire automation rules to trigger allocation on order creation and update statuses based on results"
    status: "pending"
    category: "backend"

    tasks:
      - task: "Fire workflow event after allocation completes"
        status: "pending"
        notes:
          - "Add to allocate.go after ProcessAllocation()"
        files:
          - path: "business/sdk/workflow/workflowactions/inventory/allocate.go"
            status: "pending"

      - task: "Seed automation rules for order workflow"
        status: "pending"
        notes:
          - "Rule 1: Order Created -> Allocate Inventory"
          - "Rule 2: Allocation Success -> Update Status to ALLOCATED"
          - "Rule 3: Allocation Failure -> Create Alert"
        files:
          - path: "business/sdk/dbtest/seedFrontend.go"
            status: "pending"

      - task: "Verify batch update works for multiple line items"
        status: "pending"
        notes:
          - "updatefield.go should handle multiple line items per order"
        files:
          - path: "business/sdk/workflow/workflowactions/data/updatefield.go"
            status: "pending"

    validation:
      - check: "Go compilation passes"
        status: "pending"
      - check: "Order creation triggers allocation workflow"
        status: "pending"
      - check: "Allocation success updates line items to ALLOCATED"
        status: "pending"
      - check: "Allocation failure keeps PENDING and creates alert"
        status: "pending"

    deliverables:
      - "Workflow event firing in allocate.go"
      - "Automation rules in seedFrontend.go"
      - "Integration test for workflow transitions"

    blockers: []

  - phase: 3
    name: "Alert System Enhancement"
    description: "Extend alert action to support role-based recipients and proper delivery"
    status: "pending"
    category: "fullstack"

    tasks:
      - task: "Design alert routing model"
        status: "pending"
        notes:
          - "Decide: user vs role recipients"
          - "Decide: in-app only or also email"
        files: []

      - task: "Create alert database tables"
        status: "pending"
        notes:
          - "workflow.alerts"
          - "workflow.alert_recipients"
          - "workflow.alert_acknowledgments"
        files:
          - path: "business/sdk/migrate/sql/migrate.sql"
            status: "pending"

      - task: "Implement alert delivery"
        status: "pending"
        notes:
          - "In-app delivery mechanism"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/alert.go"
            status: "pending"

      - task: "Add UI for viewing/acknowledging alerts"
        status: "pending"
        notes:
          - "Frontend component for alert display"
        files: []

    validation:
      - check: "Go compilation passes"
        status: "pending"
      - check: "Alerts created with role-based recipients"
        status: "pending"
      - check: "Users can view and acknowledge alerts"
        status: "pending"

    deliverables:
      - "Alert database tables migration"
      - "Enhanced alert action handler"
      - "Alert UI components"

    blockers: []

context:
  current_focus: "Phase 1 plan reviewed and approved"
  next_task: "Begin Phase 1 implementation"
  recent_changes:
    - "Initial plan structure created"
    - "Phase 1 detailed plan created"
    - "Phase 1 plan reviewed and approved"
    - "Removed caching from Phase 1 (simplification)"
  decisions:
    - "Decision: Use form config FK resolution (not template variables) for default status values"
    - "Decision: Names resolved to UUIDs at formdata processing time"
    - "Decision: Implementing phases sequentially to maintain stability"
    - "Decision: No caching for FK resolution (simplicity over optimization)"

dependencies:
  internal: []  # Phase 2 depends on Phase 1, Phase 3 depends on Phase 2
  external: []  # No external plan dependencies

milestones:
  - name: "Planning Complete"
    status: "in_progress"
    date: null
  - name: "Phase 1 Complete - FK Default Resolution"
    status: "pending"
    date: null
  - name: "Phase 2 Complete - Workflow Integration"
    status: "pending"
    date: null
  - name: "Phase 3 Complete - Alert System"
    status: "pending"
    date: null
  - name: "Project Complete"
    status: "pending"
    date: null
