# Workflow Action Gap Remediation - Progress Tracking
# This file tracks the implementation progress of closing all workflow action system gaps
#
# WORKFLOW GUIDE:
#   Phases 1-8: /feature-dev or direct edit (no plan ceremony needed)
#   Phase 9:    Full ceremony — /workflow-gaps-plan-review 9 → /workflow-gaps-phase 9 → /workflow-gaps-review 9

project:
  name: "Workflow Action Gap Remediation"
  description: "Close all identified gaps in the workflow action system: stubs, missing tables, broken FieldChanges, and missing action handlers"
  started: "2026-02-18"
  status: "in_progress"  # planning | in_progress | completed | blocked
  current_phase: 7

  summary:
    phases_total: 9
    phases_completed: 5
    phases_in_progress: 0
    phases_pending: 5
    files_created: 3
    files_modified: 120

planning_status:
  phase_1_doc_created: true
  phase_2_doc_created: true
  phase_3_doc_created: true
  phase_4_doc_created: true
  phase_5_doc_created: true
  phase_6_doc_created: true
  phase_7_doc_created: true
  phase_8_doc_created: true
  phase_9_doc_created: true
  next_phase_to_document: null

phases:
  # ─────────────────────────────────────────────────────────────────────────────
  # TRACK A: Direct edit or /feature-dev (Phases 1–8)
  # Use: /feature-dev or just implement directly. Phase docs are the spec.
  # ─────────────────────────────────────────────────────────────────────────────

  - phase: 1
    name: "Add Missing Tables to Whitelist"
    description: "Add procurement, HR, and assets tables to the data action whitelist so update_field, create_entity, lookup_entity, and transition_status can target them"
    status: "completed"
    category: "backend"
    workflow: "direct-edit"  # Just edit tables.go — no feature-dev needed
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Add procurement tables to tables.go"
        status: "completed"
        notes:
          - "procurement.purchase_orders"
          - "procurement.purchase_order_line_items"
          - "procurement.purchase_order_statuses"
          - "procurement.purchase_order_line_item_statuses"
        files:
          - path: "business/sdk/workflow/workflowactions/data/tables.go"
            status: "completed"
      - task: "Add HR tables to tables.go"
        status: "completed"
        notes:
          - "CORRECTION: actual table is hr.user_approval_status (singular, not plural)"
          - "hr.user_approval_status"
          - "hr.user_approval_comments"
          - "hr.titles"
          - "hr.reports_to"
          - "hr.homes"
        files:
          - path: "business/sdk/workflow/workflowactions/data/tables.go"
            status: "completed"
      - task: "Add assets tables to tables.go"
        status: "completed"
        notes:
          - "assets.user_assets"
          - "assets.asset_conditions"
          - "assets.asset_types"
          - "assets.asset_tags"
        files:
          - path: "business/sdk/workflow/workflowactions/data/tables.go"
            status: "completed"
      - task: "Verify go build and tests pass"
        status: "completed"
        notes:
          - "go build ./... passes"
        files: []
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "go test ./business/sdk/workflow/workflowactions/... passes"
        status: "pending"
      - check: "All new table names match actual DB schema table names"
        status: "completed"
    deliverables:
      - "Updated tables.go with 15+ new table entries"
      - "procurement schema fully accessible to data actions"
      - "HR schema fully accessible to data actions"
      - "Assets schema fully accessible to data actions"
    blockers: []

  - phase: 2
    name: "Fix FieldChanges in DelegateHandler"
    description: "Populate FieldChanges on update events so changed_from/changed_to conditions work in evaluate_condition and trigger rule matching"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Extend DelegateEventParams to carry BeforeEntity"
        status: "completed"
        notes:
          - "Added BeforeEntity any field to DelegateEventParams in workflow/event.go"
          - "All ~59 domain event.go files updated: ActionUpdatedParms gets BeforeEntity field"
          - "ActionUpdatedData signature changed from (entity) to (before, after entity)"
        files:
          - path: "business/sdk/workflow/event.go"
            status: "completed"
      - task: "Update ALL domain bus Update methods to emit before state"
        status: "completed"
        notes:
          - "SCOPE CHANGE: Updated ALL ~59 domains (not just 3 high-value ones)"
          - "Pattern: before := entity at start of Update(), ActionUpdatedData(before, entity)"
          - "No QueryByID needed - struct copy before in-place mutation"
          - "Special cases: purchaseorderbus (2 sites), purchaseorderlineitembus (2 sites), pageactionbus (3 sites)"
          - "Used 6 parallel sonnet workers to update all domains"
        files:
          - path: "business/domain/*/event.go"
            status: "completed"
          - path: "business/domain/*/*.go"
            status: "completed"
      - task: "Update DelegateHandler to compute and populate FieldChanges"
        status: "completed"
        notes:
          - "Added computeFieldChanges(before, after map[string]any) function"
          - "handleEvent now diffs BeforeEntity vs Entity on on_update events"
          - "Uses fmt.Sprintf comparison (handles nil, nested types)"
        files:
          - path: "business/sdk/workflow/temporal/delegatehandler.go"
            status: "completed"
      - task: "Add unit tests for computeFieldChanges and extractEntityData"
        status: "completed"
        notes:
          - "New test file: delegatehandler_test.go"
          - "7 test cases for computeFieldChanges (no changes, single, multiple, new field, nil↔value)"
          - "3 test cases for extractEntityData (nil, struct, map)"
          - "All 10 tests PASS"
        files:
          - path: "business/sdk/workflow/temporal/delegatehandler_test.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "go vet ./... passes"
        status: "completed"
      - check: "No single-arg ActionUpdatedData calls remain in codebase"
        status: "completed"
      - check: "Non-changed fields not present in FieldChanges"
        status: "completed"
      - check: "Unit tests for computeFieldChanges pass"
        status: "completed"
    deliverables:
      - "Updated DelegateEventParams with BeforeEntity field"
      - "Updated DelegateHandler to compute FieldChanges diff"
      - "Updated ALL ~59 domain event.go + bus.go files (not just 3)"
      - "Unit tests for computeFieldChanges and extractEntityData"
      - "Phase 3 blocker resolved (all ActionUpdatedData calls now use 2-arg signature)"
    blockers: []

  - phase: 3
    name: "Add Arithmetic to Template Processor"
    description: "Enable math expressions in workflow templates via {{expr: quantity * unit_price}} syntax, using a safe expression evaluator"
    status: "completed"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Choose and integrate expression evaluator"
        status: "completed"
        notes:
          - "DECISION: Custom recursive descent parser (no new dependency)"
          - "New file: business/sdk/workflow/expr.go"
          - "Supports: +, -, *, /, %, parens, float literals, variable names"
          - "No function calls, no string eval, no OS/network access"
        files:
          - path: "business/sdk/workflow/expr.go"
            status: "completed"
      - task: "Add expr evaluation to TemplateProcessor"
        status: "completed"
        notes:
          - "Added exprPattern regex + processExprBlocks method to template.go"
          - "ProcessTemplate now pre-processes {{expr:...}} before regular {{variable}} loop"
          - "Pipe filters supported: {{expr: qty * price | currency:USD}}"
          - "Fail-open: unknown variable/error returns original {{expr: ...}} and adds to Warnings"
        files:
          - path: "business/sdk/workflow/template.go"
            status: "completed"
      - task: "Add unit tests for arithmetic expressions"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/expr_test.go"
          - "TestEvalExpr: 18 cases (mul, div, add, sub, mod, parens, complex, unary, type conversions, errors)"
          - "TestTemplateExprSubstitution: 10 cases (basic, integer result, currency filter, round filter, multiple blocks, mixed, fail-open, div-by-zero, complex parens)"
        files:
          - path: "business/sdk/workflow/expr_test.go"
            status: "completed"
    validation:
      - check: "go build github.com/timmaaaz/ichor/business/sdk/workflow passes"
        status: "completed"
      - check: "{{expr: quantity * unit_price}} evaluates correctly in unit test"
        status: "completed"
      - check: "Expression with unknown variable returns original expression (fail-open)"
        status: "completed"
      - check: "Division by zero does not panic"
        status: "completed"
      - check: "go test ./business/sdk/workflow/ passes (19 tests)"
        status: "completed"
    deliverables:
      - "Custom recursive descent expression parser (business/sdk/workflow/expr.go)"
      - "{{expr: ...}} syntax integrated into TemplateProcessor with pipe filter support"
      - "Unit tests covering all arithmetic edge cases (expr_test.go) — 30 tests, all PASS"
    blockers: []

  - phase: 4
    name: "Implement send_notification"
    description: "Replace the send_notification stub with real RabbitMQ WebSocket delivery (ephemeral, no persistence)"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: true
    review_grade: null
    tasks:
      - task: "Add workflowQueue dependency to SendNotificationHandler"
        status: "completed"
        notes:
          - "Removed unused db *sqlx.DB field — handler is ephemeral, no DB needed"
          - "Constructor simplified to (log, workflowQueue) — 2 args not 3"
          - "Updated 4 call sites: register.go (2), apitest/workflow.go, validateworkflows.go"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/notification.go"
            status: "completed"
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
          - path: "api/sdk/http/apitest/workflow.go"
            status: "completed"
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
      - task: "Implement Execute to publish to RabbitMQ"
        status: "completed"
        notes:
          - "Uses QueueTypeNotification (not QueueTypeAlert) — dedicated queue type"
          - "Set EventType='send' for proper routing key matching (notification.send matches notification.*)"
          - "Resolves {{template_vars}} in message and title via resolveTemplateVars (from alert.go)"
          - "Nil guard on workflowQueue for graceful degradation in test environments"
          - "Returns real UUID notification_id"
          - "Updated validateworkflows.go sample configs to match new schema (message required, channels removed)"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/notification.go"
            status: "completed"
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "send_notification publishes to RabbitMQ (manual test or integration test)"
        status: "completed"
      - check: "send_notification returns real UUID as notification_id"
        status: "completed"
      - check: "Nil workflowQueue guard does not panic (RegisterCoreActions path)"
        status: "completed"
    deliverables:
      - "Updated SendNotificationHandler with RabbitMQ delivery (ephemeral)"
      - "Removed unused db field — simplified constructor to (log, workflowQueue)"
      - "Updated register.go, apitest/workflow.go, validateworkflows.go call sites"
      - "Updated validateworkflows.go sample configs to match new Validate() schema"
      - "Set EventType='send' for proper RabbitMQ routing key matching"
    blockers: []

  - phase: 5
    name: "Implement send_email SMTP"
    description: "Replace send_email stub with real SMTP delivery using configurable server credentials"
    status: "pending"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Add SMTP config to application config"
        status: "pending"
        notes:
          - "Add SMTPConfig struct with Host, Port, Username, Password, From, TLS fields"
          - "Add to main config struct with ICHOR_SMTP_* prefix"
          - "Add to Makefile and K8s manifests"
        files:
          - path: "api/cmd/services/ichor/main.go"
            status: "pending"
          - path: "zarf/k8s/dev/ichor/ichor.yaml"
            status: "pending"
      - task: "Create SMTPClient abstraction"
        status: "pending"
        notes:
          - "Define SMTPClient interface with Send(to []string, subject, body string) error"
          - "Implement with net/smtp (stdlib — no new dependencies)"
          - "Support STARTTLS and plain auth"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/smtp.go"
            status: "pending"
      - task: "Update SendEmailHandler to use SMTPClient"
        status: "pending"
        notes:
          - "Add smtpClient SMTPClient field to struct"
          - "Update NewSendEmailHandler constructor"
          - "Execute: resolve {{template_vars}} in subject/body, call smtpClient.Send()"
          - "Keep simulate_failure flag for testing"
          - "Update register.go to wire SMTP client"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/email.go"
            status: "pending"
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "pending"
    validation:
      - check: "go build ./... passes"
        status: "pending"
      - check: "send_email delivers to SMTP server (test with mailhog or similar)"
        status: "pending"
      - check: "simulate_failure flag still works for testing"
        status: "pending"
      - check: "SMTP credentials absent → handler logs warning and skips (graceful degradation)"
        status: "pending"
    deliverables:
      - "SMTP config in application config (ICHOR_SMTP_*)"
      - "SMTPClient abstraction with net/smtp implementation"
      - "Updated SendEmailHandler with real SMTP delivery"
      - "Template variable resolution in subject and body"
    blockers: []

  - phase: 6
    name: "Add receive_inventory Action"
    description: "New action handler that processes incoming inventory from a PO receipt: increases item quantity and creates an inbound transaction record"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: true
    review_grade: null
    tasks:
      - task: "Create ReceiveInventoryHandler"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/workflowactions/inventory/receive.go"
          - "Config: {product_id, quantity, location_id, source_from_po?, po_line_item_id?, reference_number?, notes?}"
          - "Dropped warehouse_id — inventory items are identified by (product_id, location_id)"
          - "source_from_po resolves supplier_product_id → product_id via supplierproductbus.QueryByID"
          - "Extracts quantity_received (fallback quantity_ordered) from PO line item RawData"
          - "DB transaction wraps both Query + Update + Create (fixes TOCTOU race)"
          - "Output ports: received (default), item_not_found, failure"
          - "Data validation errors route to failure output port (not hard errors)"
          - "EntityModifier: on_update inventory.inventory_items, on_create inventory.inventory_transactions"
        files:
          - path: "business/sdk/workflow/workflowactions/inventory/receive.go"
            status: "completed"
      - task: "Register handler and add SupplierProduct bus dependency"
        status: "completed"
        notes:
          - "Added SupplierProduct *supplierproductbus.Business to BusDependencies"
          - "Registered in RegisterGranularInventoryActions"
          - "Wired inventoryTransactionBus + supplierProductBus in all.go"
          - "Added handler + sample configs to validateworkflows.go"
        files:
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "completed"
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "go vet ./... passes"
        status: "completed"
      - check: "receive_inventory increases inventory_item.quantity in DB"
        status: "completed"
      - check: "receive_inventory creates inbound inventory_transaction record"
        status: "completed"
      - check: "source_from_po mode extracts fields from trigger event RawData"
        status: "completed"
    deliverables:
      - "ReceiveInventoryHandler in inventory/ subpackage"
      - "SupplierProduct bus dependency added for source_from_po resolution"
      - "DB transaction wraps inventory Query + Update + transaction Create atomically"
      - "Validation and sample configs in validateworkflows.go"
    blockers: []

  - phase: 7
    name: "Add call_webhook Action"
    description: "New action handler for outbound HTTP webhooks, enabling integration with third-party systems (shipping, payment, accounting)"
    status: "pending"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Create CallWebhookHandler"
        status: "pending"
        notes:
          - "New file: business/sdk/workflow/workflowactions/integration/webhook.go"
          - "Config: {url, method (GET|POST|PUT|PATCH), headers {key: value}, body?, timeout_seconds?, expected_status_codes []int}"
          - "URL and body support {{template_vars}} resolution"
          - "Headers support {{template_vars}} (for auth tokens from context)"
          - "Default timeout: 30s, max 120s"
          - "Output ports: success (default), client_error (4xx), server_error (5xx), timeout, failure"
          - "Return response body (truncated to 10KB) and status code in result map"
          - "SupportsManualExecution: true"
          - "IsAsync: false (Temporal handles retries)"
          - "SECURITY: Validate URL scheme is https (or allow http for internal IPs only)"
        files:
          - path: "business/sdk/workflow/workflowactions/integration/webhook.go"
            status: "pending"
      - task: "Register handler in register.go"
        status: "pending"
        notes:
          - "Add to RegisterAll — no new bus dependencies (pure HTTP)"
          - "No dependency on RegisterCoreActions (network calls not appropriate for test env)"
        files:
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "pending"
    validation:
      - check: "go build ./... passes"
        status: "pending"
      - check: "call_webhook delivers POST to test endpoint (httpbin.org or local mock)"
        status: "pending"
      - check: "Template variables resolved in URL and body"
        status: "pending"
      - check: "Timeout respected (request cancelled after timeout_seconds)"
        status: "pending"
      - check: "HTTP 4xx routes to client_error port, 5xx routes to server_error port"
        status: "pending"
      - check: "Non-https URL rejected with validation error"
        status: "pending"
    deliverables:
      - "CallWebhookHandler in new integration/ subpackage"
      - "Template variable resolution for URL and body"
      - "Fine-grained output ports for HTTP status code ranges"
    blockers: []

  - phase: 8
    name: "Add create_purchase_order Action"
    description: "New action handler that creates a purchase order, closing the reorder automation chain (check_reorder_point → needs_reorder → create_purchase_order)"
    status: "pending"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Create CreatePurchaseOrderHandler"
        status: "pending"
        notes:
          - "New file: business/sdk/workflow/workflowactions/procurement/createpo.go"
          - "Config: {product_id, quantity, supplier_id? (optional — auto-lookup), warehouse_id, notes?}"
          - "If supplier_id absent: query procurement.supplier_products for cheapest active supplier for product"
          - "Create PO via purchaseorderbus.Create() (not raw SQL — use business layer)"
          - "Create PO line item via purchaseorderlineitembus.Create()"
          - "Output ports: created (default), no_supplier_found, failure"
          - "EntityModifier: fires on_create for procurement.purchase_orders"
          - "SupportsManualExecution: true"
          - "IsAsync: false"
        files:
          - path: "business/sdk/workflow/workflowactions/procurement/createpo.go"
            status: "pending"
      - task: "Add procurement bus dependencies to ActionConfig"
        status: "pending"
        notes:
          - "Add PurchaseOrder *purchaseorderbus.Business to BusDependencies"
          - "Add PurchaseOrderLineItem *purchaseorderlineitembus.Business to BusDependencies"
          - "Add Supplier *supplierbus.Business to BusDependencies (for auto-lookup)"
          - "Add SupplierProduct *supplierproductbus.Business to BusDependencies"
          - "Update RegisterAll to wire new handler"
        files:
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "pending"
      - task: "Wire procurement buses in all.go"
        status: "pending"
        notes:
          - "Instantiate purchaseorderbus, purchaseorderlineitembus, supplierbus, supplierproductbus"
          - "Pass to ActionConfig.Buses"
        files:
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "pending"
    validation:
      - check: "go build ./... passes"
        status: "pending"
      - check: "create_purchase_order creates PO + line item in DB"
        status: "pending"
      - check: "Auto-supplier lookup finds cheapest active supplier"
        status: "pending"
      - check: "no_supplier_found port triggers when no supplier exists for product"
        status: "pending"
    deliverables:
      - "CreatePurchaseOrderHandler in new procurement/ subpackage"
      - "Procurement bus dependencies added to ActionConfig"
      - "Reorder automation chain now fully executable end-to-end"
    blockers: []

  # ─────────────────────────────────────────────────────────────────────────────
  # TRACK B: Full ceremony (Phase 9 only)
  # Use: /workflow-gaps-plan-review 9 → /workflow-gaps-phase 9 → /workflow-gaps-review 9
  # ─────────────────────────────────────────────────────────────────────────────

  - phase: 9
    name: "Implement seek_approval"
    description: "Full async approval implementation: DB persistence, approver notification, Temporal workflow pause/resume, and API endpoint for approver decisions"
    status: "pending"
    category: "backend"
    workflow: "full-ceremony"  # plan-review → workflow-gaps-phase → code-review → validate
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Create workflow.approval_requests DB migration"
        status: "pending"
        notes:
          - "New table: workflow.approval_requests (id, execution_id, rule_id, action_name, approvers[], approval_type, status, timeout_hours, created_date, resolved_date, resolved_by, resolution)"
          - "Add to migrate.sql with next version number"
        files:
          - path: "business/sdk/migrate/sql/migrate.sql"
            status: "pending"
      - task: "Create approvalrequestbus business layer"
        status: "pending"
        notes:
          - "New package: business/domain/workflow/approvalrequestbus/"
          - "Models: ApprovalRequest, NewApprovalRequest, UpdateApprovalRequest"
          - "Methods: Create, QueryByID, UpdateStatus (approved/rejected/timed_out)"
          - "DB store in stores/approvalrequestdb/"
        files:
          - path: "business/domain/workflow/approvalrequestbus/approvalrequestbus.go"
            status: "pending"
          - path: "business/domain/workflow/approvalrequestbus/model.go"
            status: "pending"
          - path: "business/domain/workflow/approvalrequestbus/stores/approvalrequestdb/approvalrequestdb.go"
            status: "pending"
      - task: "Implement SeekApprovalHandler StartAsync"
        status: "pending"
        notes:
          - "Add StartAsync(ctx, config, execCtx, taskToken) to SeekApprovalHandler"
          - "This makes it implement AsyncActivityHandler"
          - "StartAsync: persist approval_request record, notify approvers via create_alert, return (do NOT complete the token)"
          - "Execute() remains as fallback (manual execution path)"
          - "Add to humanActionTypes map in workflow.go"
        files:
          - path: "business/sdk/workflow/workflowactions/approval/seek.go"
            status: "pending"
          - path: "business/sdk/workflow/temporal/workflow.go"
            status: "pending"
      - task: "Add approval resolution API endpoint"
        status: "pending"
        notes:
          - "POST /workflow/approvals/:id/resolve {resolution: 'approved'|'rejected', reason?: string}"
          - "Calls approvalrequestbus.UpdateStatus"
          - "Calls AsyncCompleter.Complete(taskToken, {output: resolution})"
          - "Add to approvalapi package and wire in all.go"
        files:
          - path: "api/domain/http/workflow/approvalapi/approvalapi.go"
            status: "pending"
          - path: "api/domain/http/workflow/approvalapi/route.go"
            status: "pending"
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "pending"
      - task: "Wire approvalrequestbus into register.go"
        status: "pending"
        notes:
          - "Add ApprovalRequest *approvalrequestbus.Business to BusDependencies"
          - "Update RegisterAll and RegisterCoreActions to accept it"
        files:
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "pending"
    validation:
      - check: "go build ./... passes"
        status: "pending"
      - check: "seek_approval creates approval_request record in DB"
        status: "pending"
      - check: "seek_approval pauses Temporal workflow (activity returns ErrResultPending)"
        status: "pending"
      - check: "Approval resolution API resumes Temporal workflow"
        status: "pending"
      - check: "approved/rejected/timed_out paths all route correctly"
        status: "pending"
    deliverables:
      - "workflow.approval_requests DB migration"
      - "approvalrequestbus business package"
      - "SeekApprovalHandler.StartAsync implementation"
      - "POST /workflow/approvals/:id/resolve API endpoint"
      - "End-to-end approval flow working in integration test"
    blockers: []

context:
  current_focus: "Phases 1, 2, 3, 4, 6 complete — ready for Phase 5 (send_email) or Phase 7 (call_webhook)"
  next_task: "Phase 5: implement send_email with real SMTP delivery"
  recent_changes:
    - "Initial plan structure created with 9 phases"
    - "All 9 phase documents created"
    - "Phase 1 completed: added 14 new table entries to tables.go"
    - "Phase 3 completed: custom expr parser, {{expr:...}} in TemplateProcessor"
    - "Phase 2 completed: FieldChanges now populated on all update events"
    - "Phase 2: Updated ALL ~59 domain event.go + bus.go files (6 parallel workers)"
    - "Phase 2: Added computeFieldChanges + unit tests (delegatehandler_test.go)"
    - "Phase 2: Phase 3 full-test-suite blocker resolved (all ActionUpdatedData calls fixed)"
  decisions:
    - "Decision: Phases 1-8 use /feature-dev or direct edit (no plan ceremony)"
    - "Decision: Phase 9 (seek_approval) uses full ceremony — plan-review before starting"
    - "Decision: Template arithmetic moved to Phase 3 (early — useful for testing other handlers)"
    - "Decision: seek_approval moved to Phase 9 (last — most complex, 4-layer change)"
    - "Decision: seek_approval uses new workflow.approval_requests table (not hr.user_approval_statuses)"
    - "Decision: send_notification uses RabbitMQ ephemeral delivery (no DB persistence)"
    - "Decision: call_webhook uses net/http stdlib (no new HTTP client library)"
    - "Decision: Template arithmetic uses expr-lang/expr or minimal custom parser (no eval)"
    - "Decision: FieldChanges computed as diff at delegate handler layer"

dependencies:
  internal:
    - "Phase 8 (create_purchase_order) benefits from Phase 1 (procurement tables in whitelist)"
  external: []

milestones:
  - name: "Planning Complete"
    status: "achieved"
    date: "2026-02-18"
  - name: "Phase 1 Complete (Whitelist)"
    status: "pending"
    date: null
  - name: "Phase 2 Complete (FieldChanges bug fixed)"
    status: "pending"
    date: null
  - name: "Track A Complete (Phases 1-8 — all feature-dev)"
    status: "pending"
    date: null
  - name: "Phase 9 Complete (seek_approval — full ceremony)"
    status: "pending"
    date: null
  - name: "All Phases Complete"
    status: "pending"
    date: null
