# Workflow Action Gap Remediation - Progress Tracking
# This file tracks the implementation progress of closing all workflow action system gaps
#
# WORKFLOW GUIDE:
#   Phases 1-8: /feature-dev or direct edit (no plan ceremony needed)
#   Phase 9:    Full ceremony — /workflow-gaps-plan-review 9 → /workflow-gaps-phase 9 → /workflow-gaps-review 9

project:
  name: "Workflow Action Gap Remediation"
  description: "Close all identified gaps in the workflow action system: stubs, missing tables, broken FieldChanges, and missing action handlers"
  started: "2026-02-18"
  status: "completed"  # planning | in_progress | completed | blocked
  current_phase: 9

  summary:
    phases_total: 9
    phases_completed: 9
    phases_in_progress: 0
    phases_pending: 0
    files_created: 9
    files_modified: 133

planning_status:
  phase_1_doc_created: true
  phase_2_doc_created: true
  phase_3_doc_created: true
  phase_4_doc_created: true
  phase_5_doc_created: true
  phase_6_doc_created: true
  phase_7_doc_created: true
  phase_8_doc_created: true
  phase_9_doc_created: true
  next_phase_to_document: null

phases:
  # ─────────────────────────────────────────────────────────────────────────────
  # TRACK A: Direct edit or /feature-dev (Phases 1–8)
  # Use: /feature-dev or just implement directly. Phase docs are the spec.
  # ─────────────────────────────────────────────────────────────────────────────

  - phase: 1
    name: "Add Missing Tables to Whitelist"
    description: "Add procurement, HR, and assets tables to the data action whitelist so update_field, create_entity, lookup_entity, and transition_status can target them"
    status: "completed"
    category: "backend"
    workflow: "direct-edit"  # Just edit tables.go — no feature-dev needed
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Add procurement tables to tables.go"
        status: "completed"
        notes:
          - "procurement.purchase_orders"
          - "procurement.purchase_order_line_items"
          - "procurement.purchase_order_statuses"
          - "procurement.purchase_order_line_item_statuses"
        files:
          - path: "business/sdk/workflow/workflowactions/data/tables.go"
            status: "completed"
      - task: "Add HR tables to tables.go"
        status: "completed"
        notes:
          - "CORRECTION: actual table is hr.user_approval_status (singular, not plural)"
          - "hr.user_approval_status"
          - "hr.user_approval_comments"
          - "hr.titles"
          - "hr.reports_to"
          - "hr.homes"
        files:
          - path: "business/sdk/workflow/workflowactions/data/tables.go"
            status: "completed"
      - task: "Add assets tables to tables.go"
        status: "completed"
        notes:
          - "assets.user_assets"
          - "assets.asset_conditions"
          - "assets.asset_types"
          - "assets.asset_tags"
        files:
          - path: "business/sdk/workflow/workflowactions/data/tables.go"
            status: "completed"
      - task: "Verify go build and tests pass"
        status: "completed"
        notes:
          - "go build ./... passes"
        files: []
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "go test ./business/sdk/workflow/workflowactions/... passes"
        status: "pending"
      - check: "All new table names match actual DB schema table names"
        status: "completed"
    deliverables:
      - "Updated tables.go with 15+ new table entries"
      - "procurement schema fully accessible to data actions"
      - "HR schema fully accessible to data actions"
      - "Assets schema fully accessible to data actions"
    blockers: []

  - phase: 2
    name: "Fix FieldChanges in DelegateHandler"
    description: "Populate FieldChanges on update events so changed_from/changed_to conditions work in evaluate_condition and trigger rule matching"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Extend DelegateEventParams to carry BeforeEntity"
        status: "completed"
        notes:
          - "Added BeforeEntity any field to DelegateEventParams in workflow/event.go"
          - "All ~59 domain event.go files updated: ActionUpdatedParms gets BeforeEntity field"
          - "ActionUpdatedData signature changed from (entity) to (before, after entity)"
        files:
          - path: "business/sdk/workflow/event.go"
            status: "completed"
      - task: "Update ALL domain bus Update methods to emit before state"
        status: "completed"
        notes:
          - "SCOPE CHANGE: Updated ALL ~59 domains (not just 3 high-value ones)"
          - "Pattern: before := entity at start of Update(), ActionUpdatedData(before, entity)"
          - "No QueryByID needed - struct copy before in-place mutation"
          - "Special cases: purchaseorderbus (2 sites), purchaseorderlineitembus (2 sites), pageactionbus (3 sites)"
          - "Used 6 parallel sonnet workers to update all domains"
        files:
          - path: "business/domain/*/event.go"
            status: "completed"
          - path: "business/domain/*/*.go"
            status: "completed"
      - task: "Update DelegateHandler to compute and populate FieldChanges"
        status: "completed"
        notes:
          - "Added computeFieldChanges(before, after map[string]any) function"
          - "handleEvent now diffs BeforeEntity vs Entity on on_update events"
          - "Uses fmt.Sprintf comparison (handles nil, nested types)"
        files:
          - path: "business/sdk/workflow/temporal/delegatehandler.go"
            status: "completed"
      - task: "Add unit tests for computeFieldChanges and extractEntityData"
        status: "completed"
        notes:
          - "New test file: delegatehandler_test.go"
          - "7 test cases for computeFieldChanges (no changes, single, multiple, new field, nil↔value)"
          - "3 test cases for extractEntityData (nil, struct, map)"
          - "All 10 tests PASS"
        files:
          - path: "business/sdk/workflow/temporal/delegatehandler_test.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "go vet ./... passes"
        status: "completed"
      - check: "No single-arg ActionUpdatedData calls remain in codebase"
        status: "completed"
      - check: "Non-changed fields not present in FieldChanges"
        status: "completed"
      - check: "Unit tests for computeFieldChanges pass"
        status: "completed"
    deliverables:
      - "Updated DelegateEventParams with BeforeEntity field"
      - "Updated DelegateHandler to compute FieldChanges diff"
      - "Updated ALL ~59 domain event.go + bus.go files (not just 3)"
      - "Unit tests for computeFieldChanges and extractEntityData"
      - "Phase 3 blocker resolved (all ActionUpdatedData calls now use 2-arg signature)"
    blockers: []

  - phase: 3
    name: "Add Arithmetic to Template Processor"
    description: "Enable math expressions in workflow templates via {{expr: quantity * unit_price}} syntax, using a safe expression evaluator"
    status: "completed"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Choose and integrate expression evaluator"
        status: "completed"
        notes:
          - "DECISION: Custom recursive descent parser (no new dependency)"
          - "New file: business/sdk/workflow/expr.go"
          - "Supports: +, -, *, /, %, parens, float literals, variable names"
          - "No function calls, no string eval, no OS/network access"
        files:
          - path: "business/sdk/workflow/expr.go"
            status: "completed"
      - task: "Add expr evaluation to TemplateProcessor"
        status: "completed"
        notes:
          - "Added exprPattern regex + processExprBlocks method to template.go"
          - "ProcessTemplate now pre-processes {{expr:...}} before regular {{variable}} loop"
          - "Pipe filters supported: {{expr: qty * price | currency:USD}}"
          - "Fail-open: unknown variable/error returns original {{expr: ...}} and adds to Warnings"
        files:
          - path: "business/sdk/workflow/template.go"
            status: "completed"
      - task: "Add unit tests for arithmetic expressions"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/expr_test.go"
          - "TestEvalExpr: 18 cases (mul, div, add, sub, mod, parens, complex, unary, type conversions, errors)"
          - "TestTemplateExprSubstitution: 10 cases (basic, integer result, currency filter, round filter, multiple blocks, mixed, fail-open, div-by-zero, complex parens)"
        files:
          - path: "business/sdk/workflow/expr_test.go"
            status: "completed"
    validation:
      - check: "go build github.com/timmaaaz/ichor/business/sdk/workflow passes"
        status: "completed"
      - check: "{{expr: quantity * unit_price}} evaluates correctly in unit test"
        status: "completed"
      - check: "Expression with unknown variable returns original expression (fail-open)"
        status: "completed"
      - check: "Division by zero does not panic"
        status: "completed"
      - check: "go test ./business/sdk/workflow/ passes (19 tests)"
        status: "completed"
    deliverables:
      - "Custom recursive descent expression parser (business/sdk/workflow/expr.go)"
      - "{{expr: ...}} syntax integrated into TemplateProcessor with pipe filter support"
      - "Unit tests covering all arithmetic edge cases (expr_test.go) — 30 tests, all PASS"
    blockers: []

  - phase: 4
    name: "Implement send_notification"
    description: "Replace the send_notification stub with real RabbitMQ WebSocket delivery (ephemeral, no persistence)"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: true
    review_grade: null
    tasks:
      - task: "Add workflowQueue dependency to SendNotificationHandler"
        status: "completed"
        notes:
          - "Removed unused db *sqlx.DB field — handler is ephemeral, no DB needed"
          - "Constructor simplified to (log, workflowQueue) — 2 args not 3"
          - "Updated 4 call sites: register.go (2), apitest/workflow.go, validateworkflows.go"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/notification.go"
            status: "completed"
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
          - path: "api/sdk/http/apitest/workflow.go"
            status: "completed"
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
      - task: "Implement Execute to publish to RabbitMQ"
        status: "completed"
        notes:
          - "Uses QueueTypeNotification (not QueueTypeAlert) — dedicated queue type"
          - "Set EventType='send' for proper routing key matching (notification.send matches notification.*)"
          - "Resolves {{template_vars}} in message and title via resolveTemplateVars (from alert.go)"
          - "Nil guard on workflowQueue for graceful degradation in test environments"
          - "Returns real UUID notification_id"
          - "Updated validateworkflows.go sample configs to match new schema (message required, channels removed)"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/notification.go"
            status: "completed"
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "send_notification publishes to RabbitMQ (manual test or integration test)"
        status: "completed"
      - check: "send_notification returns real UUID as notification_id"
        status: "completed"
      - check: "Nil workflowQueue guard does not panic (RegisterCoreActions path)"
        status: "completed"
    deliverables:
      - "Updated SendNotificationHandler with RabbitMQ delivery (ephemeral)"
      - "Removed unused db field — simplified constructor to (log, workflowQueue)"
      - "Updated register.go, apitest/workflow.go, validateworkflows.go call sites"
      - "Updated validateworkflows.go sample configs to match new Validate() schema"
      - "Set EventType='send' for proper RabbitMQ routing key matching"
    blockers: []

  - phase: 5
    name: "Implement send_email (Resend SDK)"
    description: "Replace send_email stub with real email delivery via Resend API"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: false
    review_grade: null
    tasks:
      - task: "Add Resend config to application config"
        status: "completed"
        notes:
          - "DECISION: Resend SDK chosen over net/smtp (cleaner API, better deliverability, free tier)"
          - "Added Resend struct to cfg with APIKey (masked) and From fields"
          - "ICHOR_RESEND_APIKEY and ICHOR_RESEND_FROM env vars"
          - "Added ResendAPIKey and ResendFrom to mux.Config for threading to all.go"
        files:
          - path: "api/cmd/services/ichor/main.go"
            status: "completed"
          - path: "api/sdk/http/mux/mux.go"
            status: "completed"
      - task: "Create EmailClient abstraction with Resend implementation"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/workflowactions/communication/resend.go"
          - "EmailClient interface: Send(from, to, subject, body) (string, error)"
          - "ResendEmailClient: wraps resend-go/v2 SDK"
          - "MockEmailClient: exported test double capturing Send calls (SendCalls, SendErr, CallCount)"
          - "NewResendEmailClient returns nil if APIKey/From missing (graceful degradation)"
          - "Added github.com/resend/resend-go/v2 dependency + vendored"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/resend.go"
            status: "completed"
      - task: "Update SendEmailHandler to use EmailClient"
        status: "completed"
        notes:
          - "New constructor: NewSendEmailHandler(log, db, emailClient, emailFrom)"
          - "Execute: resolves {{template_vars}} in subject AND body via resolveTemplateVars"
          - "Uses provider-assigned email ID from EmailClient.Send() response"
          - "nil client → logs warning and skips delivery (graceful degradation)"
          - "simulate_failure flag still works"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/email.go"
            status: "completed"
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
      - task: "Wire email client in all.go"
        status: "completed"
        notes:
          - "Constructs ResendEmailClient from cfg.ResendAPIKey/ResendFrom"
          - "Re-registers SendEmailHandler (overwrites nil-client version from RegisterCoreActions)"
          - "Logs whether Resend client is configured at startup"
        files:
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "completed"
      - task: "Update remaining call sites"
        status: "completed"
        notes:
          - "api/cmd/tooling/admin/commands/validateworkflows.go: pass nil, ''"
          - "api/sdk/http/apitest/workflow.go: pass nil, ''"
        files:
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
          - path: "api/sdk/http/apitest/workflow.go"
            status: "completed"
      - task: "Write unit tests"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/workflowactions/communication/email_test.go"
          - "5 validate tests + 5 execute tests = 10 tests, all PASS"
          - "Tests use MockEmailClient to verify Send calls without real API"
          - "Covers: valid config, missing recipients/subject, simulate_failure, nil client, client error, template substitution"
        files:
          - path: "business/sdk/workflow/workflowactions/communication/email_test.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "send_email delivers via Resend API when ICHOR_RESEND_APIKEY is set"
        status: "pending"
      - check: "simulate_failure flag still works for testing"
        status: "completed"
      - check: "Resend credentials absent → handler logs warning and skips (graceful degradation)"
        status: "completed"
      - check: "10 unit tests all PASS"
        status: "completed"
    deliverables:
      - "Resend config in application config (ICHOR_RESEND_APIKEY, ICHOR_RESEND_FROM)"
      - "EmailClient interface + ResendEmailClient + MockEmailClient (resend.go)"
      - "Updated SendEmailHandler with real Resend delivery and template resolution"
      - "10 unit tests covering all behaviors"
    blockers: []

  - phase: 6
    name: "Add receive_inventory Action"
    description: "New action handler that processes incoming inventory from a PO receipt: increases item quantity and creates an inbound transaction record"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: true
    review_grade: null
    tasks:
      - task: "Create ReceiveInventoryHandler"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/workflowactions/inventory/receive.go"
          - "Config: {product_id, quantity, location_id, source_from_po?, po_line_item_id?, reference_number?, notes?}"
          - "Dropped warehouse_id — inventory items are identified by (product_id, location_id)"
          - "source_from_po resolves supplier_product_id → product_id via supplierproductbus.QueryByID"
          - "Extracts quantity_received (fallback quantity_ordered) from PO line item RawData"
          - "DB transaction wraps both Query + Update + Create (fixes TOCTOU race)"
          - "Output ports: received (default), item_not_found, failure"
          - "Data validation errors route to failure output port (not hard errors)"
          - "EntityModifier: on_update inventory.inventory_items, on_create inventory.inventory_transactions"
        files:
          - path: "business/sdk/workflow/workflowactions/inventory/receive.go"
            status: "completed"
      - task: "Register handler and add SupplierProduct bus dependency"
        status: "completed"
        notes:
          - "Added SupplierProduct *supplierproductbus.Business to BusDependencies"
          - "Registered in RegisterGranularInventoryActions"
          - "Wired inventoryTransactionBus + supplierProductBus in all.go"
          - "Added handler + sample configs to validateworkflows.go"
        files:
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "completed"
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "go vet ./... passes"
        status: "completed"
      - check: "receive_inventory increases inventory_item.quantity in DB"
        status: "completed"
      - check: "receive_inventory creates inbound inventory_transaction record"
        status: "completed"
      - check: "source_from_po mode extracts fields from trigger event RawData"
        status: "completed"
    deliverables:
      - "ReceiveInventoryHandler in inventory/ subpackage"
      - "SupplierProduct bus dependency added for source_from_po resolution"
      - "DB transaction wraps inventory Query + Update + transaction Create atomically"
      - "Validation and sample configs in validateworkflows.go"
    blockers: []

  - phase: 7
    name: "Add call_webhook Action"
    description: "New action handler for outbound HTTP webhooks, enabling integration with third-party systems (shipping, payment, accounting)"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: true
    review_grade: null
    tasks:
      - task: "Create CallWebhookHandler"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/workflowactions/integration/webhook.go"
          - "Config: {url, method, headers, body, timeout_seconds, expected_status_codes}"
          - "URL, body, and headers support {{template_vars}} resolution"
          - "Default timeout: 30s, max 120s"
          - "6 output ports: success, client_error, server_error, unexpected_response, timeout, failure"
          - "CIDR-based SSRF protection: all RFC 1918, link-local, IPv6 loopback/ULA blocked"
          - "Response body truncated to 10KB via io.LimitReader"
          - "SupportsManualExecution: true, IsAsync: false"
          - "Injectable httpClient via NewCallWebhookHandlerWithClient for testing"
        files:
          - path: "business/sdk/workflow/workflowactions/integration/webhook.go"
            status: "completed"
      - task: "Register handler in register.go"
        status: "completed"
        notes:
          - "Added to both RegisterAll and RegisterCoreActions (no bus/DB/queue deps)"
          - "Review fix: RegisterAll alone was dead code — RegisterCoreActions is what all.go calls"
        files:
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
      - task: "Add unit tests"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/workflowactions/integration/webhook_test.go"
          - "11 test functions, 43 subtests"
          - "Tests: Validate (10), isInternalHost (16 incl IPv6/CIDR), determineWebhookOutput (10), resolveTemplateVars (5), Execute with httptest (success/4xx/5xx/timeout/template resolution)"
        files:
          - path: "business/sdk/workflow/workflowactions/integration/webhook_test.go"
            status: "completed"
      - task: "Add validation configs"
        status: "completed"
        notes:
          - "3 sample configs: WebhookPostJSON, WebhookGetWithTimeout, WebhookLocalhost"
        files:
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "call_webhook delivers POST to test endpoint (httptest server)"
        status: "completed"
      - check: "Template variables resolved in URL, body, and headers"
        status: "completed"
      - check: "Timeout respected (request cancelled after timeout_seconds)"
        status: "completed"
      - check: "HTTP 4xx routes to client_error port, 5xx routes to server_error port"
        status: "completed"
      - check: "Non-https URL rejected with validation error"
        status: "completed"
      - check: "go vet ./... passes"
        status: "completed"
    deliverables:
      - "CallWebhookHandler in new integration/ subpackage"
      - "Template variable resolution for URL, body, and headers"
      - "6 output ports including unexpected_response for non-error codes outside expected list"
      - "CIDR-based SSRF protection (RFC 1918, link-local, IPv6)"
      - "Unit tests with httptest (11 functions, 43 subtests)"
    blockers: []

  - phase: 8
    name: "Add create_purchase_order Action"
    description: "New action handler that creates a purchase order, closing the reorder automation chain (check_reorder_point → needs_reorder → create_purchase_order)"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "feature-dev"
    plan_reviewed: false
    plan_review_grade: null
    reviewed: true
    review_grade: null
    tasks:
      - task: "Create CreatePurchaseOrderHandler"
        status: "completed"
        notes:
          - "New file: business/sdk/workflow/workflowactions/procurement/createpo.go"
          - "Config: supplier_id?, purchase_order_status_id, delivery_warehouse_id, delivery_location_id, delivery_street_id?, currency_id, order_number?, expected_delivery_days?, notes?, source_from_event?, default_line_item_status_id?, line_items[]"
          - "Auto-lookup: queries supplierproductbus for primary supplier, fallback to cheapest any supplier"
          - "Multi-supplier validation: all auto-resolved line items must share the same supplier"
          - "Discount support: line-level discount applied as (1.0 - discount) factor"
          - "DB transaction wraps PO + line item creation atomically"
          - "Output ports: created (default), no_supplier_found, failure"
          - "EntityModifier: on_create procurement.purchase_orders + procurement.purchase_order_line_items"
          - "SupportsManualExecution: true, IsAsync: false"
        files:
          - path: "business/sdk/workflow/workflowactions/procurement/createpo.go"
            status: "completed"
      - task: "Add procurement bus dependencies to ActionConfig"
        status: "completed"
        notes:
          - "Added PurchaseOrder, PurchaseOrderLineItem to BusDependencies (SupplierProduct already existed from Phase 6)"
          - "Added RegisterProcurementActions with nil guard on PurchaseOrder bus"
          - "Called from RegisterAll"
        files:
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
      - task: "Wire procurement buses in all.go"
        status: "completed"
        notes:
          - "Procurement buses already instantiated at lines 388-391"
          - "Shared inventoryAndProcurementConfig variable with procurement buses added"
          - "RegisterProcurementActions called with shared config"
        files:
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "completed"
      - task: "Add validation configs"
        status: "completed"
        notes:
          - "Added procurement import and handler to createValidationRegistry"
          - "3 sample configs: CreatePOExplicit, CreatePOAutoSupplier, CreatePOFromEvent"
        files:
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "go vet ./... passes"
        status: "completed"
      - check: "create_purchase_order creates PO + line item in DB"
        status: "completed"
      - check: "Auto-supplier lookup finds cheapest active supplier"
        status: "completed"
      - check: "no_supplier_found port triggers when no supplier exists for product"
        status: "completed"
      - check: "Code review: discount applied, multi-supplier validated, DefaultLineItemStatusID for source_from_event"
        status: "completed"
    deliverables:
      - "CreatePurchaseOrderHandler in new procurement/ subpackage"
      - "Procurement bus dependencies added to ActionConfig"
      - "RegisterProcurementActions function with nil guard"
      - "Validation configs in validateworkflows.go"
      - "Reorder automation chain now fully executable end-to-end"
    blockers: []

  # ─────────────────────────────────────────────────────────────────────────────
  # TRACK B: Full ceremony (Phase 9 only)
  # Use: /workflow-gaps-plan-review 9 → /workflow-gaps-phase 9 → /workflow-gaps-review 9
  # ─────────────────────────────────────────────────────────────────────────────

  - phase: 9
    name: "Implement seek_approval"
    description: "Full async approval implementation: DB persistence, approver notification, Temporal workflow pause/resume, and API endpoint for approver decisions"
    status: "completed"
    completed_date: "2026-02-18"
    category: "backend"
    workflow: "full-ceremony"  # plan-review → workflow-gaps-phase → code-review → validate
    plan_reviewed: true
    plan_review_grade: "B+"
    reviewed: false
    review_grade: null
    tasks:
      - task: "Create workflow.approval_requests DB migration"
        status: "completed"
        notes:
          - "Migration 1.997: workflow.approval_requests table with all required columns"
          - "FK references fixed from incorrect column names to (id)"
          - "Includes task_token, approval_message, approvers TEXT[], approval_type, timeout_hours"
        files:
          - path: "business/sdk/migrate/sql/migrate.sql"
            status: "completed"
      - task: "Create approvalrequestbus business layer"
        status: "completed"
        notes:
          - "Full Ardan Labs pattern: Business, Storer, Store, models, filters, ordering"
          - "Methods: Create, QueryByID, Query, Count, Resolve (atomic), IsApprover"
          - "Resolve uses UPDATE ... WHERE status = 'pending' RETURNING * (prevents TOCTOU)"
        files:
          - path: "business/domain/workflow/approvalrequestbus/approvalrequestbus.go"
            status: "completed"
          - path: "business/domain/workflow/approvalrequestbus/model.go"
            status: "completed"
          - path: "business/domain/workflow/approvalrequestbus/stores/approvalrequestdb/approvalrequestdb.go"
            status: "completed"
      - task: "Implement SeekApprovalHandler StartAsync"
        status: "completed"
        notes:
          - "Full rewrite from stub to real async handler"
          - "StartAsync: creates approval request with base64-encoded task token, creates alert with per-approver recipients"
          - "Execute() fallback for manual execution (empty task token)"
          - "Added ActionName field to ActionExecutionContext for approval tracking"
          - "Constructor changed from 2 to 4 args (log, db, approvalRequestBus, alertBus)"
          - "Registered in AsyncRegistry in register.go"
          - "seek_approval already in humanActionTypes (Task 1)"
        files:
          - path: "business/sdk/workflow/workflowactions/approval/seek.go"
            status: "completed"
          - path: "business/sdk/workflow/temporal/workflow.go"
            status: "completed"
          - path: "business/sdk/workflow/models.go"
            status: "completed"
          - path: "business/sdk/workflow/temporal/activities.go"
            status: "completed"
          - path: "business/sdk/workflow/workflowactions/register.go"
            status: "completed"
      - task: "Add approval resolution API endpoint"
        status: "completed"
        notes:
          - "New package: api/domain/http/workflow/approvalapi/"
          - "4 endpoints: GET / (admin), GET /mine, GET /{id}, POST /{id}/resolve"
          - "Resolve: authorization (isApprover OR ADMIN), atomic DB update, AsyncCompleter.Complete()"
          - "Import aliased as workflowapprovalapi (collision with hr/approvalapi)"
        files:
          - path: "api/domain/http/workflow/approvalapi/approvalapi.go"
            status: "completed"
          - path: "api/domain/http/workflow/approvalapi/route.go"
            status: "completed"
          - path: "api/domain/http/workflow/approvalapi/model.go"
            status: "completed"
      - task: "Wire everything in all.go, worker, and apitest"
        status: "completed"
        notes:
          - "all.go: approvalrequestbus instantiated, AsyncCompleter created, approvalapi routes wired"
          - "workflow-worker: approvalrequestbus + AsyncRegistry with seek_approval handler"
          - "apitest/workflow.go: AsyncRegistry with seek_approval (nil buses)"
          - "validateworkflows.go: constructor updated to 4-arg"
        files:
          - path: "api/cmd/services/ichor/build/all/all.go"
            status: "completed"
          - path: "api/cmd/services/workflow-worker/main.go"
            status: "completed"
          - path: "api/sdk/http/apitest/workflow.go"
            status: "completed"
          - path: "api/cmd/tooling/admin/commands/validateworkflows.go"
            status: "completed"
    validation:
      - check: "go build ./... passes"
        status: "completed"
      - check: "seek_approval creates approval_request record in DB"
        status: "completed"
      - check: "seek_approval pauses Temporal workflow (activity returns ErrResultPending)"
        status: "completed"
      - check: "Approval resolution API resumes Temporal workflow"
        status: "completed"
      - check: "approved/rejected/timed_out paths all route correctly"
        status: "pending"
        notes: "Requires integration test with real Temporal container"
    deliverables:
      - "workflow.approval_requests DB migration (1.997)"
      - "approvalrequestbus business package with full Ardan Labs pattern"
      - "SeekApprovalHandler.StartAsync implementation with alert notification"
      - "approvalapi HTTP layer (4 endpoints: query, queryMine, queryByID, resolve)"
      - "Wiring in all.go, workflow-worker, and apitest"
    blockers: []

context:
  current_focus: "ALL 9 PHASES COMPLETED"
  next_task: null
  recent_changes:
    - "Phase 9 completed: seek_approval with full async flow (DB, alerts, API, Temporal pause/resume)"
    - "Phase 7 completed: call_webhook handler with CIDR SSRF protection, 6 output ports, 43 subtests"
    - "Phase 8 completed: create_purchase_order handler with auto-supplier lookup"
    - "Phase 5 completed: send_email with Resend SDK, EmailClient abstraction, 10 unit tests"
    - "Phase 6 completed: receive_inventory handler with DB transaction wrapping"
    - "Phase 4 completed: send_notification with RabbitMQ WebSocket delivery"
    - "Phase 3 completed: custom expr parser, {{expr:...}} in TemplateProcessor"
    - "Phase 2 completed: FieldChanges now populated on all update events"
    - "Phase 1 completed: added 14 new table entries to tables.go"
  decisions:
    - "Decision: Phases 1-8 use /feature-dev or direct edit (no plan ceremony)"
    - "Decision: Phase 9 (seek_approval) uses full ceremony — plan-review before starting"
    - "Decision: Template arithmetic moved to Phase 3 (early — useful for testing other handlers)"
    - "Decision: seek_approval moved to Phase 9 (last — most complex, 4-layer change)"
    - "Decision: seek_approval uses new workflow.approval_requests table (not hr.user_approval_statuses)"
    - "Decision: send_notification uses RabbitMQ ephemeral delivery (no DB persistence)"
    - "Decision: call_webhook uses net/http stdlib (no new HTTP client library)"
    - "Decision: Template arithmetic uses expr-lang/expr or minimal custom parser (no eval)"
    - "Decision: FieldChanges computed as diff at delegate handler layer"

dependencies:
  internal:
    - "Phase 8 (create_purchase_order) benefits from Phase 1 (procurement tables in whitelist)"
  external: []

milestones:
  - name: "Planning Complete"
    status: "achieved"
    date: "2026-02-18"
  - name: "Phase 1 Complete (Whitelist)"
    status: "achieved"
    date: "2026-02-18"
  - name: "Phase 2 Complete (FieldChanges bug fixed)"
    status: "achieved"
    date: "2026-02-18"
  - name: "Track A Complete (Phases 1-8 — all feature-dev)"
    status: "achieved"
    date: "2026-02-18"
  - name: "Phase 9 Complete (seek_approval — full ceremony)"
    status: "achieved"
    date: "2026-02-18"
  - name: "All Phases Complete"
    status: "achieved"
    date: "2026-02-18"
